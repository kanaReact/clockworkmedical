const dceSignaturePads=new WeakMap();const signaturePadWrappers=new Set();function initializeSignaturePad(wrapper,$scope,$){const previous=dceSignaturePads.get(wrapper);if(previous){if(previous.updateValue){previous.signaturePad.removeEventListener("afterUpdateStroke",previous.updateValue)}
previous.signaturePad.off();if(previous.clearButton&&previous.clearHandler){previous.clearButton.removeEventListener("click",previous.clearHandler)}}
const canvas=wrapper.querySelector("canvas");const hiddenInput=wrapper.querySelector("input");const clearButton=wrapper.querySelector("[data-action=clear]");const aspectRatio=parseFloat(canvas.getAttribute("data-aspect-ratio"))||2;const useJPEG=canvas.getAttribute("data-jpeg")==="yes";let rect=wrapper.getBoundingClientRect();let actualWidth=Math.round(rect.width);let actualHeight=Math.round(actualWidth/aspectRatio);canvas.width=actualWidth;canvas.height=actualHeight;let signaturePad=new SignaturePad(canvas,{penColor:canvas.getAttribute("data-pen-color"),backgroundColor:canvas.getAttribute("data-background-color"),});const updateValue=()=>{if(!signaturePad.isEmpty()){hiddenInput.value=signaturePad.toDataURL(`image/${useJPEG ? 'jpeg' : 'png'}`)}else{hiddenInput.value=""}};signaturePad.addEventListener("afterUpdateStroke",updateValue);const clearHandler=function(){const context=canvas.getContext("2d");context.fillStyle=canvas.getAttribute("data-background-color");context.fillRect(0,0,canvas.width,canvas.height);signaturePad.clear();hiddenInput.value=""};clearButton.addEventListener("click",clearHandler);const padData={wrapper,canvas,signaturePad,hiddenInput,aspectRatio,useJPEG,updateValue,clearButton,clearHandler};dceSignaturePads.set(wrapper,padData);signaturePadWrappers.add(wrapper)}
function onWindowResize(){signaturePadWrappers.forEach((wrapper)=>{if(!document.body.contains(wrapper)){signaturePadWrappers.delete(wrapper);return}
const obj=dceSignaturePads.get(wrapper);if(!obj){signaturePadWrappers.delete(wrapper);return}
let{canvas,signaturePad,hiddenInput,aspectRatio,useJPEG}=obj;let rect=wrapper.getBoundingClientRect();if(rect.width===0||rect.height===0){return}
const oldData=signaturePad.toData();const oldWidth=canvas.width;const oldHeight=canvas.height;let newWidth=Math.round(rect.width);let newHeight=Math.round(newWidth/aspectRatio);if(newWidth===oldWidth){return}
canvas.width=newWidth;canvas.height=newHeight;if(obj.updateValue){signaturePad.removeEventListener("afterUpdateStroke",obj.updateValue)}
signaturePad.off();signaturePad=new SignaturePad(canvas,{penColor:canvas.getAttribute("data-pen-color"),backgroundColor:canvas.getAttribute("data-background-color"),});obj.signaturePad=signaturePad;const scaleX=newWidth/oldWidth;const scaleY=newHeight/oldHeight;oldData.forEach((stroke)=>{stroke.points.forEach((point)=>{point.x*=scaleX;point.y*=scaleY;point.pressure*=scaleX})});signaturePad.fromData(oldData);const updateValue=()=>{if(!signaturePad.isEmpty()){hiddenInput.value=signaturePad.toDataURL(`image/${useJPEG ? 'jpeg' : 'png'}`)}else{hiddenInput.value=""}};signaturePad.addEventListener("afterUpdateStroke",updateValue);obj.updateValue=updateValue})}
function WidgetElements_FormSignature($scope,$){let wrappers=$scope.find(".dce-signature-wrapper");wrappers.each((_,wrapper)=>initializeSignaturePad(wrapper,$scope,$));$scope.on("dce-field-shown",function(event,fieldId){let $fieldWrapper=$scope.find(".elementor-field-group-"+fieldId);let $signatureWrappers=$fieldWrapper.find(".dce-signature-wrapper");$signatureWrappers.each((_,wrapper)=>{let existingPad=dceSignaturePads.get(wrapper);if(!existingPad||existingPad.canvas.width===0){initializeSignaturePad(wrapper,$scope,$)}})})}
jQuery(window).on("elementor/frontend/init",function(){elementorFrontend.hooks.addAction("frontend/element_ready/form.default",WidgetElements_FormSignature)});let resizeTimeout;window.addEventListener("resize",function(){clearTimeout(resizeTimeout);resizeTimeout=setTimeout(onWindowResize,250)})